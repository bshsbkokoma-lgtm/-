<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏ö‡∏ä‡∏≠‡∏ö - ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 1rem;
            background-color: white;
            padding: 1.5rem;
            max-width: 90%;
            margin: 2rem auto;
            animation: fadeIn 1s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-box {
            background-color: #ffe4e6; /* Rose 100 */
            border: 2px solid #fda4af; /* Rose 300 */
            color: #e11d48; /* Rose 600 */
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: bold;
            font-size: 1.5rem;
        }
        /* Style for the secret header, ensuring it looks like normal text */
        #main-header {
            cursor: default; 
            user-select: none; /* Prevents text selection on repeated click */
        }
        /* Style for preventing background scroll when modal is active */
        .overflow-hidden-body {
            overflow: hidden !important;
        }
    </style>
</head>
<body id="body">

    <div id="app" class="min-h-screen flex flex-col items-center pt-8 pb-8">

        <!-- Main Love Calculator Card (User View) -->
        <div class="card w-full lg:w-1/2">
            <!-- This is the secret trigger element -->
            <h1 id="main-header" class="text-3xl font-extrabold text-center text-pink-600 mb-6">
                ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏ö‡∏ä‡∏≠‡∏ö üíñ
            </h1>
            <p class="text-center text-gray-500 mb-6">
                ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏≠‡∏ö‡∏ä‡∏≠‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏´‡∏ô!
            </p>

            <form id="love-form" class="space-y-4">
                <div>
                    <label for="user-name" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</label>
                    <input type="text" id="user-name" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏Å‡πà"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150">
                </div>
                <div>
                    <label for="crush-name" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏≠‡∏ö‡∏ä‡∏≠‡∏ö:</label>
                    <input type="text" id="crush-name" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏Ç‡πà"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150">
                </div>
                <button type="submit" id="submit-button"
                        class="w-full py-3 px-4 bg-pink-600 text-white font-bold rounded-lg hover:bg-pink-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2">
                    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô!
                </button>
            </form>

            <!-- Result Display -->
            <div id="result-container" class="mt-6 hidden">
                <div class="result-box" id="result-text"></div>
            </div>

            <!-- Custom Modal for Messages (No alert/confirm) -->
            <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-3" id="modal-title">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                    <p id="modal-message" class="text-gray-600 mb-4"></p>
                    <button onclick="closeModal('message-modal')"
                            class="w-full py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600">
                        ‡∏ï‡∏Å‡∏•‡∏á
                    </button>
                </div>
            </div>

             <!-- Admin Key Input Modal -->
             <div id="admin-key-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">üîê ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á</h3>
                    <p class="text-gray-600 mb-4 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á (Admin Key) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</p>
                    <input type="password" id="admin-key-input" placeholder="Admin Key"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150 mb-4">
                    <div class="flex space-x-2">
                        <button id="admin-key-submit"
                                class="flex-1 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition duration-200">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                        <button onclick="closeModal('admin-key-modal')"
                                class="flex-1 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>
                </div>
            </div>

            <!-- Send Message Modal (New) -->
            <div id="send-message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">‚úâÔ∏è ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö</h3>
                    <p class="text-gray-600 mb-2 text-sm">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö: <span id="recipient-id-display" class="font-mono text-xs bg-gray-100 p-1 rounded"></span></p>
                    <form id="send-message-form">
                        <input type="hidden" id="recipient-id-input">
                        <textarea id="message-text-input" rows="4" required placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£..."
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150 mb-4"></textarea>
                        <div class="flex space-x-2">
                            <button type="submit"
                                    class="flex-1 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition duration-200">
                                ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                            </button>
                            <button type="button" onclick="closeModal('send-message-modal')"
                                    class="flex-1 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Admin View Panel (Creator Only) -->
        <div id="admin-panel" class="card w-full lg:w-3/4 mt-8 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á)</h2>
            <p id="admin-info" class="text-sm text-gray-500 mb-4">
                User ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span id="current-user-id" class="font-mono text-xs bg-gray-100 p-1 rounded">Auth Required</span>
                <span class="text-xs text-green-600 block mt-1" id="config-status">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>
            </p>
            <div id="matches-list" class="space-y-3">
                <!-- Data will be injected here -->
                <p class="text-center text-gray-400" id="no-data-msg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</p>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, doc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment (These are available only in Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        // **********************************************************************************
        // Firebase Project Configuration (Complete from user input)
        // **********************************************************************************
        const customFirebaseConfig = {
          apiKey: "AIzaSyBvUK7L_Ttf_vxtrMBu1MX07sXQMhuJxc4", 
          authDomain: "love-a358c.firebaseapp.com", 
          projectId: "love-a358c",
          storageBucket: "love-a358c.firebasestorage.app",
          messagingSenderId: "343186428531",
          appId: "1:343186428531:web:beaaaec0532015abe41006",
          measurementId: "G-C3ZZJ9NEN4"
        };
        
        // Use custom config for GitHub Pages, or environment config for Canvas
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : customFirebaseConfig;


        // --- HARDCODED ADMIN KEY ---
        const CREATOR_ADMIN_KEY = '2552'; 

        let db, auth, userId = 'Auth Required'; // Default status
        let isAdminLoggedIn = false; 

        // Variables for the triple-click detection
        let clickCount = 0;
        let lastClickTime = 0;
        const TRIPLE_CLICK_INTERVAL = 400; // milliseconds

        // Set log level for debugging Firestore issues
        setLogLevel('Debug');

        // --- Utility Functions ---
        
        function openModal(modalId) {
            document.getElementById('body').classList.add('overflow-hidden-body');
            document.getElementById(modalId).classList.remove('hidden');
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById('body').classList.remove('overflow-hidden-body');
            // Reset message modal title/content if it was used for confirmation
            document.getElementById('modal-title').textContent = '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô';
            // Restore default OK button behavior
            const modalContent = document.getElementById('message-modal').querySelector('.bg-white');
            const buttonContainer = modalContent.querySelector('.flex.space-x-2');
            if(buttonContainer) buttonContainer.remove();
            
            let defaultBtn = modalContent.querySelector('button');
            if(!defaultBtn) {
                 defaultBtn = document.createElement('button');
                 defaultBtn.textContent = '‡∏ï‡∏Å‡∏•‡∏á';
                 defaultBtn.onclick = () => closeModal(modalId);
                 defaultBtn.className = 'w-full py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600';
                 modalContent.appendChild(defaultBtn);
            }
        }

        function showMessage(message, title = '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            openModal('message-modal');
        }

        function getRandomCompatibility() {
            // Generates a compatibility percentage between 40% and 100%
            return Math.floor(Math.random() * (100 - 40 + 1)) + 40;
        }

        // --- Firebase Initialization and Authentication ---
        const configStatusEl = document.getElementById('config-status');

        if (firebaseConfig && firebaseConfig.projectId && firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                configStatusEl.textContent = `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Project ID: ${firebaseConfig.projectId}`;
                configStatusEl.classList.remove('text-red-500');
                configStatusEl.classList.add('text-green-600');
                
                // Handle Authentication 
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('current-user-id').textContent = userId;
                        // IMPORTANT: Start listening for messages immediately after successful login
                        setupMessageListener(); 
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                // Sign in anonymously for general users on static hosting
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            document.getElementById('current-user-id').textContent = 'Auth Failed';
                            showMessage("‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Firebase ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (Auth failed) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('current-user-id').textContent = 'Init Failed';
                configStatusEl.textContent = `Error: Firebase Init Failed (${error.message})`;
                configStatusEl.classList.add('text-red-500');
                showMessage("‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console");
            }

        } else {
            console.error("Firebase configuration is incomplete or missing. Data storage is disabled.");
            document.getElementById('current-user-id').textContent = 'Config Missing';
            configStatusEl.textContent = "Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö Firebase Config ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå";
            configStatusEl.classList.add('text-red-500');
            showMessage("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        }

        // --- Firestore Data Functions ---

        /**
         * Saves the match result to the public Firestore collection.
         */
        async function saveMatch(userName, crushName, compatibility) {
            if (!db || userId.includes('Failed') || userId === 'Auth Required' || userId === 'Config Missing') {
                console.warn("Firestore not ready or user not authenticated. Data not saved.");
                showMessage("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡πÅ‡∏•‡∏∞ Security Rules (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)");
                return;
            }

            // Path for public data: /artifacts/{appId}/public/data/crush_matches
            const collectionPath = `artifacts/${appId}/public/data/crush_matches`;

            try {
                await addDoc(collection(db, collectionPath), {
                    userName: userName,
                    crushName: crushName,
                    compatibility: compatibility,
                    timestamp: serverTimestamp(),
                    submittedBy: userId,
                });
                console.log("Match data saved successfully.");
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: (‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å Security Rules ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï) " + e.message);
            }
        }

        /**
         * Deletes a match entry by document ID.
         * @param {string} docId The ID of the document to delete.
         */
        window.deleteMatch = async function(docId) {
            if (!db || !isAdminLoggedIn) {
                showMessage("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠ Firebase ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
                return;
            }

            const confirmDelete = await showDeleteConfirmation();
            if (!confirmDelete) return;

            const collectionPath = `artifacts/${appId}/public/data/crush_matches`;
            const docRef = doc(db, collectionPath, docId);

            try {
                await deleteDoc(docRef);
                showMessage("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
            }
        }
        
        /**
         * Displays a custom confirmation modal for deletion.
         */
        function showDeleteConfirmation() {
            return new Promise((resolve) => {
                const modalId = 'message-modal';
                const modalElement = document.getElementById(modalId);
                const modalMessage = document.getElementById('modal-message');
                const modalContent = modalElement.querySelector('.bg-white');
                const defaultBtn = modalContent.querySelector('button');
                if(defaultBtn) defaultBtn.remove(); // Remove default button

                modalMessage.innerHTML = '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?';
                document.getElementById('modal-title').textContent = '‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö';


                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex space-x-2 mt-4';

                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö';
                confirmBtn.className = 'flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200';
                confirmBtn.onclick = () => {
                    closeModal(modalId);
                    resolve(true);
                };

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                cancelBtn.className = 'flex-1 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition duration-200';
                cancelBtn.onclick = () => {
                    closeModal(modalId);
                    resolve(false);
                };

                buttonContainer.appendChild(cancelBtn);
                buttonContainer.appendChild(confirmBtn);
                modalContent.appendChild(buttonContainer);
                
                openModal(modalId);
            });
        }

        /**
         * Opens the modal to send a message to a specific recipient.
         * @param {string} recipientId The User ID of the recipient.
         */
        window.openSendMessageModal = function(recipientId) {
            document.getElementById('recipient-id-display').textContent = recipientId;
            document.getElementById('recipient-id-input').value = recipientId;
            document.getElementById('message-text-input').value = '';
            openModal('send-message-modal');
        }

        /**
         * Saves the message to the public user_messages collection.
         */
        async function sendMessage(recipientId, messageText) {
            if (!db || !isAdminLoggedIn) {
                showMessage("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°");
                return;
            }

            const collectionPath = `artifacts/${appId}/public/data/user_messages`;

            try {
                await addDoc(collection(db, collectionPath), {
                    recipientId: recipientId,
                    senderId: userId, // Creator's UID
                    message: messageText,
                    timestamp: serverTimestamp(),
                });
                showMessage("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ " + recipientId + " ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "‚úâÔ∏è ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            } catch (e) {
                console.error("Error sending message: ", e);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: " + e.message);
            }
        }
        
        /**
         * Sets up a real-time listener for messages addressed to the current user.
         */
        function setupMessageListener() {
            if (!db || userId.includes('Required') || userId.includes('Failed')) {
                // If auth is not ready or failed, do not set up listener
                return;
            }
            
            const collectionPath = `artifacts/${appId}/public/data/user_messages`;
            // Query messages where the recipientId matches the current user's UID
            const q = query(collection(db, collectionPath), where("recipientId", "==", userId));
            
            // Listen for changes
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    // Only process new messages
                    if (change.type === "added") {
                        const messageData = change.doc.data();
                        const messageId = change.doc.id;
                        
                        // 1. Show the notification to the user
                        showMessage(`üíå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á:\n\n"${messageData.message}"`, "üéâ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©!");
                        
                        // 2. IMPORTANT: Delete the message immediately after displaying it
                        // This makes it a one-time notification
                        const docRef = doc(db, collectionPath, messageId);
                        deleteDoc(docRef).catch(e => console.error("Error deleting message after read:", e));
                    }
                });
            }, (error) => {
                console.error("Error listening to messages: ", error);
            });
        }

        /**
         * Sets up a real-time listener for the Admin Panel.
         */
        function setupAdminDataListener() {
            if (!db) return;

            const collectionPath = `artifacts/${appId}/public/data/crush_matches`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                const matchesListDiv = document.getElementById('matches-list');
                const noDataMsg = document.getElementById('no-data-msg');
                let htmlContent = '';
                let hasData = false;

                snapshot.docs.forEach((doc) => {
                    hasData = true;
                    const data = doc.data();
                    const docId = doc.id; // Get the document ID for deletion
                    const timestamp = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' }) : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤';

                    // Display all sensitive information and action buttons
                    htmlContent += `
                        <div class="p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${data.userName} ‡πÅ‡∏≠‡∏ö‡∏ä‡∏≠‡∏ö ${data.crushName}</p>
                                <p class="text-pink-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô: ${data.compatibility}%</p>
                                <p class="text-xs text-gray-500">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${timestamp} | User ID: ${data.submittedBy.substring(0, 8)}... (${docId})</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="openSendMessageModal('${data.submittedBy}')" 
                                    class="p-2 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 shadow-md">
                                    ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                                </button>
                                <button onclick="deleteMatch('${docId}')" 
                                    class="p-2 text-xs bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-200 shadow-md">
                                    ‡∏•‡∏ö
                                </button>
                            </div>
                        </div>
                    `;
                });

                matchesListDiv.innerHTML = htmlContent;

                if (hasData) {
                    noDataMsg.classList.add('hidden');
                } else {
                    noDataMsg.classList.remove('hidden');
                    matchesListDiv.innerHTML = ''; // Ensure list is cleared if no data
                }
            }, (error) => {
                console.error("Error listening to collection: ", error);
                matchesListDiv.innerHTML = `<p class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Security Rules) ${error.message}</p>`;
            });
        }


        // --- Event Listeners and Main Logic ---

        document.getElementById('love-form').addEventListener('submit', async function(event) {
            event.preventDefault();

            const userName = document.getElementById('user-name').value.trim();
            const crushName = document.getElementById('crush-name').value.trim();

            if (userName === "" || crushName === "") {
                showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì");
                return;
            }

            // 1. Calculate and Display Result (The part the user sees)
            const compatibility = getRandomCompatibility();
            const resultText = document.getElementById('result-text');
            const resultContainer = document.getElementById('result-container');

            resultText.innerHTML = `
                <div class="text-3xl font-extrabold">${userName} & ${crushName}</div>
                <div class="mt-2 text-6xl font-black">${compatibility}%</div>
                <div class="mt-2 text-xl">${getCompatibilityMessage(compatibility)}</div>
            `;
            resultContainer.classList.remove('hidden');

            // 2. Save data to Firestore (The part only the creator sees)
            await saveMatch(userName, crushName, compatibility);

            // Clear the form after submission
            document.getElementById('love-form').reset();
        });
        
        // Handle Send Message Form Submission
        document.getElementById('send-message-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const recipientId = document.getElementById('recipient-id-input').value;
            const messageText = document.getElementById('message-text-input').value.trim();

            if (messageText) {
                await sendMessage(recipientId, messageText);
                closeModal('send-message-modal');
            } else {
                showMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á");
            }
        });


        /**
         * Provides a fun message based on the percentage.
         */
        function getCompatibilityMessage(percent) {
            if (percent >= 90) return "‡∏ß‡πâ‡∏≤‡∏ß! ‡∏û‡∏£‡∏´‡∏°‡∏•‡∏¥‡∏Ç‡∏¥‡∏ï‡∏ä‡∏±‡∏î‡πÜ! ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏¥‡πà‡∏á‡∏¢‡∏ß‡∏î! üíç";
            if (percent >= 75) return "‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡∏•‡∏≠‡∏á‡∏ó‡∏±‡∏Å‡πÑ‡∏õ‡∏Ñ‡∏∏‡∏¢‡∏î‡∏π‡πÄ‡∏•‡∏¢‡πÑ‡∏´‡∏°? üí¨";
            if (percent >= 60) return "‡∏û‡∏≠‡∏î‡∏µ‡πä‡∏û‡∏≠‡∏î‡∏µ! ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏π‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏µ‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞! ‚ú®";
            if (percent >= 40) return "‡∏Å‡πá... ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô! üòâ";
            return "‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≥ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏ß‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞! ‡∏™‡∏π‡πâ‡πÜ! üí™";
        }

        // --- Triple Click Admin Trigger Logic ---
        document.getElementById('main-header').addEventListener('click', function(e) {
            
            // Block triple click if any modal is currently visible
            if (!document.getElementById('message-modal').classList.contains('hidden') || 
                !document.getElementById('admin-key-modal').classList.contains('hidden') ||
                !document.getElementById('send-message-modal').classList.contains('hidden')) {
                return; 
            }

            const currentTime = new Date().getTime();

            if (currentTime - lastClickTime < TRIPLE_CLICK_INTERVAL) {
                clickCount++;
            } else {
                // If clicks are too slow, reset the counter
                clickCount = 1;
            }

            lastClickTime = currentTime;

            if (clickCount === 3) {
                clickCount = 0; // Reset counter after successful triple-click
                
                const adminPanel = document.getElementById('admin-panel');
                
                if (isAdminLoggedIn) {
                    // If already logged in, just toggle the panel visibility
                    adminPanel.classList.toggle('hidden');
                } else {
                    // If not logged in, show the key input modal
                    openModal('admin-key-modal');
                    document.getElementById('admin-key-input').value = ''; 
                    document.getElementById('admin-key-input').focus();
                }
            }
        });

        // Handle Admin Key Submission
        document.getElementById('admin-key-submit').addEventListener('click', function() {
            const keyInput = document.getElementById('admin-key-input').value.trim();

            if (keyInput === CREATOR_ADMIN_KEY) {
                isAdminLoggedIn = true;
                closeModal('admin-key-modal'); // Use the closing function to restore scroll
                document.getElementById('admin-panel').classList.remove('hidden');

                // Start fetching data only when the Admin Key is correct
                setupAdminDataListener();
            } else {
                showMessage("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
                document.getElementById('admin-key-input').value = ''; // Clear wrong key
            }
        });
    </script>
</body>
</html>

