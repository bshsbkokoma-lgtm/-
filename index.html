<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏ö‡∏ä‡∏≠‡∏ö</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Thai:wght@400;600;700&display=swap');
        body {
            font-family: 'Noto Sans Thai', 'Inter', sans-serif;
            background-color: #fce7f3; /* Light Pink Background */
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 md:p-8">
    <div id="app-container" class="w-full max-w-xl">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-pink-600 mb-2">üíò ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏ö‡∏ä‡∏≠‡∏ö üíò</h1>
            <p class="text-gray-600">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ</p>
        </header>

        <!-- Main Compatibility Card -->
        <div id="compatibility-card" class="bg-white p-6 md:p-8 rounded-xl card-shadow border-t-4 border-pink-500 mb-8">
            <div id="auth-status" class="text-xs text-gray-500 mb-4 text-right">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</div>
            <div id="user-id-display" class="text-xs text-gray-400 mb-4 truncate" style="word-break: break-all;"></div>

            <form id="compatibility-form" class="space-y-4">
                <div>
                    <label for="your-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                    <input type="text" id="your-name" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏Å‡πâ‡∏ß"
                           class="mt-1 block w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                </div>
                <div>
                    <label for="crush-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö</label>
                    <input type="text" id="crush-name" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏≤‡∏¢‡∏∏"
                           class="mt-1 block w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                </div>
                <button type="submit" id="calculate-button"
                        class="w-full py-3 px-4 bg-pink-500 text-white font-bold rounded-xl hover:bg-pink-600 transition duration-150 transform hover:scale-[1.01] focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2 disabled:bg-pink-300">
                    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì!
                </button>
            </form>

            <!-- Result Display -->
            <div id="result-container" class="mt-6 hidden text-center p-4 border-2 border-pink-200 rounded-xl bg-pink-50">
                <h2 class="text-xl font-semibold text-gray-800">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</h2>
                <div id="compatibility-percent" class="text-6xl font-extrabold text-pink-500 mt-2">--%</div>
                <p id="compatibility-message" class="text-lg text-gray-700 mt-2"></p>
                <button onclick="document.getElementById('result-container').classList.add('hidden');"
                        class="mt-4 text-sm text-pink-500 hover:text-pink-700 transition duration-150">
                    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                </button>
            </div>

             <!-- Error/Loading Message Box (Replacing alert()) -->
            <div id="message-box" class="mt-4 p-3 hidden rounded-lg text-sm" role="alert"></div>

        </div>
        
        <!-- Admin Data Table (Hidden by default) -->
        <div id="admin-data-section" class="mt-10 hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2 border-pink-300">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏±‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</h2>
            <div class="overflow-x-auto bg-white p-4 rounded-xl card-shadow">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-pink-100">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">‡πÄ‡∏ß‡∏•‡∏≤</th>
                        </tr>
                    </thead>
                    <tbody id="admin-data-body" class="bg-white divide-y divide-gray-200 text-sm">
                        <!-- Data will be inserted here by JavaScript -->
                        <tr><td colspan="4" class="text-center py-4 text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- ADMIN CONFIGURATION (CRITICAL) ---
        // !!! IMPORTANT: REPLACE 'YOUR_ADMIN_UID_HERE' WITH YOUR ACTUAL USER ID !!!
        const ADMIN_UID_TO_REPLACE = 'YOUR_ADMIN_UID_HERE'; 
        // -------------------------------------

        // Global Firebase variables
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const authStatusEl = document.getElementById('auth-status');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const messageBox = document.getElementById('message-box');
        const adminDataSection = document.getElementById('admin-data-section');
        const adminDataBody = document.getElementById('admin-data-body');

        // Helper to display messages (instead of alert)
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else {
                messageBoxBox.classList.add('bg-blue-100', 'text-blue-700');
            }
        }

        // 1. Initialize Firebase and Authentication
        async function initializeAppAndAuth() {
            try {
                // Set Firestore log level for debugging
                setLogLevel('error');
                
                // Parse Firebase Config safely
                const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const firebaseConfig = JSON.parse(firebaseConfigString);

                // --- DEFENSIVE CHECK ADDED HERE ---
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    console.error("FIREBASE_CONFIG_ERROR: Project ID missing from Firebase config.");
                    authStatusEl.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö Firebase';
                    showMessage('‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase', 'error');
                    return; // Stop initialization if config is invalid
                }
                // ----------------------------------

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                authStatusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
                
                // Sign in using custom token or anonymously
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be confirmed
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                        userIdDisplayEl.innerHTML = `Your User ID: <span class="font-mono text-gray-500">${userId}</span>`;
                        
                        // Check for admin status and start data listener
                        if (userId === ADMIN_UID_TO_REPLACE && ADMIN_UID_TO_REPLACE !== 'YOUR_ADMIN_UID_HERE') {
                            adminDataSection.classList.remove('hidden');
                            listenForAdminData();
                        } else if (ADMIN_UID_TO_REPLACE === 'YOUR_ADMIN_UID_HERE') {
                            showMessage('‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà YOUR_ADMIN_UID_HERE ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏ß‡∏¢ Your User ID ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', 'error');
                        }

                    } else {
                        // This should ideally not happen if signInAnonymously is used as fallback
                        authStatusEl.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
                        userId = null;
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ${error.message}`, 'error');
                authStatusEl.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
            }
        }

        // 2. Data Listener for Admin View
        function listenForAdminData() {
            if (!db) return;

            // Data is stored in the public collection path: artifacts/{appId}/public/data/compatibility_results
            const resultsCollectionRef = collection(db, `artifacts/${appId}/public/data/compatibility_results`);
            const q = query(resultsCollectionRef);

            // Use onSnapshot to get real-time updates
            onSnapshot(q, (snapshot) => {
                let html = '';
                if (snapshot.empty) {
                    html = '<tr><td colspan="4" class="text-center py-4 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</td></tr>';
                } else {
                    const results = [];
                    snapshot.forEach(doc => {
                        results.push({ id: doc.id, ...doc.data() });
                    });

                    // Sort data by timestamp descending
                    results.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                    results.forEach(data => {
                        const date = data.timestamp ? data.timestamp.toDate().toLocaleString('th-TH', { 
                            hour: '2-digit', minute: '2-digit', second: '2-digit', 
                            day: '2-digit', month: 'short', year: 'numeric' 
                        }) : 'N/A';
                        
                        html += `
                            <tr class="hover:bg-pink-50 transition duration-100">
                                <td class="px-3 py-3 whitespace-nowrap">${data.userName || '-'}</td>
                                <td class="px-3 py-3 whitespace-nowrap">${data.crushName || '-'}</td>
                                <td class="px-3 py-3 whitespace-nowrap font-bold text-pink-600">${data.percentage}%</td>
                                <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-500">${date}</td>
                            </tr>
                        `;
                    });
                }
                adminDataBody.innerHTML = html;
            }, (error) => {
                console.error("Error listening to data: ", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•", 'error');
                adminDataBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            });
        }

        // 3. Compatibility Calculation and Submission
        const form = document.getElementById('compatibility-form');
        const resultContainer = document.getElementById('result-container');
        const compatibilityPercentEl = document.getElementById('compatibility-percent');
        const compatibilityMessageEl = document.getElementById('compatibility-message');
        const calculateButton = document.getElementById('calculate-button');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db || !userId) {
                showMessage('‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', 'error');
                return;
            }

            calculateButton.disabled = true;
            calculateButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...';
            messageBox.classList.add('hidden');

            const userName = document.getElementById('your-name').value.trim();
            const crushName = document.getElementById('crush-name').value.trim();

            if (!userName || !crushName) {
                 showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                 calculateButton.disabled = false;
                 calculateButton.textContent = '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì!';
                 return;
            }

            // Simple random percentage calculation (Client-side logic)
            const percentage = Math.floor(Math.random() * 101); // 0 to 100

            // Determine message based on percentage
            let message = '';
            if (percentage >= 80) {
                message = '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏™‡∏∏‡∏î‡πÜ ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢! ‡∏•‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡∏ô‡∏∞!';
            } else if (percentage >= 60) {
                message = '‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏î‡∏µ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏•‡∏≠‡∏á‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢!';
            } else if (percentage >= 40) {
                message = '‡∏û‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ... ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢';
            } else {
                message = '‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏à ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ô‡∏∞!';
            }

            // Display result to the user
            compatibilityPercentEl.textContent = `${percentage}%`;
            resultContainer.classList.remove('hidden');
            compatibilityMessageEl.textContent = message;


            // Save Data to Firestore (Admin will see this persistent log)
            try {
                // This collection is marked as 'public' in the security rules
                const resultsCollectionRef = collection(db, `artifacts/${appId}/public/data/compatibility_results`);

                await addDoc(resultsCollectionRef, {
                    userName: userName, // Logged for admin
                    crushName: crushName, // Logged for admin
                    percentage: percentage,
                    timestamp: serverTimestamp(),
                    submitterId: userId // The ID of the person who submitted the form
                });

            } catch (error) {
                console.error("Error saving document: ", error);
                showMessage(`‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`, 'error');
            } finally {
                calculateButton.disabled = false;
                calculateButton.textContent = '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì!';
            }
        });

        // Initialize on load
        window.onload = initializeAppAndAuth;

    </script>
</body>
</html>

